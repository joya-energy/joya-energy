<div class="energy-audit-page">
  <div class="energy-audit-container">
    <!-- Sidebar with Step Progress -->
    <aside class="simulator-sidebar">
      <div class="sidebar-steps">
        @for (step of steps; track step.number) {
          <div 
            class="sidebar-step-item" 
            [class.active]="currentStep() === step.number"
            [class.clickable]="isStepClickable(step.number) && !step.isResult"
            [class.disabled]="!isStepClickable(step.number) && !step.isResult"
            (click)="!step.isResult && goToStep(step.number)">
            @if (!step.isResult) {
              <app-ui-progress-bar
                [step]="step.number"
                [title]="step.title"
                [progress]="stepProgress()[step.number]"
                [completed]="stepProgress()[step.number] === 100"
                [isFocused]="currentStep() === step.number"
                class="sidebar-progress-bar">
              </app-ui-progress-bar>
            } @else {
              <!-- Result step - matches progress bar layout but without progress bar -->
              <div class="sidebar-result-step" [class.active]="currentStep() === step.number" [class.disabled]="true">
                <div class="sidebar-result-step-left">
                  <div 
                    class="sidebar-step-circle result"
                    [class.active]="currentStep() === step.number">
                    <span class="step-number">{{ step.number }}</span>
                  </div>
                </div>
                <div class="sidebar-result-step-right">
                  <h3 class="sidebar-step-title">{{ step.title }}</h3>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="simulator-main">
      <!-- Fixed Timeline Header -->
      <div class="form-timeline-header">
        <div class="step-progress-header">
          <span class="step-indicator">Étape {{ currentStep() }} sur {{ steps.length }}</span>
          <span class="step-completion">Progression: {{ overallProgress() }}%</span>
        </div>
        <app-ui-step-timeline
          [currentStep]="currentStep()"
          [totalSteps]="steps.length">
        </app-ui-step-timeline>
      </div>

      <!-- Scrollable Step Content Area -->
      <div class="form-content-scrollable">
        <div class="form-content">
          <!-- Dynamic Step Content - Unique div that changes per step -->
          <div class="step-content" [attr.data-step]="currentStep()">
          @if (currentStepData().isResult) {
            <!-- Results View -->
            <div class="results-view">
              <h1>Résultats de votre audit</h1>
              @if (simulationResult(); as result) {
                <div class="results-content">
                  <p>Simulation ID: {{ result.simulationId }}</p>
                  <p>Créé le: {{ result.createdAt | date:'medium' }}</p>
                  <!-- Add more result display as needed -->
                </div>
              } @else {
                <p>Les calculs sont en cours...</p>
              }
            </div>
          } @else {
            <!-- Form Fields -->
            <form [formGroup]="form" class="simulator-form">
              <div class="simulator-form-header">
                <h3 class="simulator-form-title">Calculateur Audit Énergétique</h3>
                <h2 class="step-title">{{ currentStepData().title }}</h2>
                @if (currentStepData().description) {
                  <p class="step-description">{{ currentStepData().description }}</p>
                }
              </div>
              
              <!-- Step Components (Modular) -->
              @if (currentStep() === 1) {
                <app-step-building
                  [form]="form"
                  [buildingCategories]="buildingCategories"
                  [buildingTypes]="buildingTypes"
                  [activityTypes]="formServiceInstance.activityTypes"
                  [climateZones]="formServiceInstance.climateZones">
                </app-step-building>
              } @else if (currentStep() === 2) {
                <app-step-technical [form]="form"></app-step-technical>
              } @else if (currentStep() === 3) {
                <app-step-equipment [form]="form"></app-step-equipment>
              } @else if (currentStep() === 4) {
                <app-step-personal [form]="form"></app-step-personal>
              }
            </form>
          }
          </div>
        </div>
      </div>

      <!-- Fixed Navigation Buttons Footer -->
      <div class="form-actions">
        <button
          type="button"
          class="hero__btn hero__btn--outline"
          [disabled]="!canGoBack()"
          (click)="previousStep()">
          <ng-icon name="lucideArrowLeft" size="16"></ng-icon>
          Précédent
        </button>

        @if (!currentStepData().isResult) {
          @if (currentStep() < lastFormStepNumber) {
            <button
              type="button"
              class="hero__btn hero__btn--primary"
              [disabled]="!canProceed() || isSubmitting()"
              (click)="nextStep()">
              Suivant
              <ng-icon name="lucideArrowRight" size="16"></ng-icon>
            </button>
          } @else {
            <button
              type="button"
              class="hero__btn hero__btn--primary"
              [disabled]="!canProceed() || isSubmitting()"
              (click)="submitForm()">
              @if (isSubmitting()) {
                <span>Envoi...</span>
              } @else {
                <span>Voir les résultats</span>
                <ng-icon name="lucideArrowRight" size="16"></ng-icon>
              }
            </button>
          }
        }
      </div>
    </main>
  </div>
</div>
