<div class="energy-audit-page">
  <div class="energy-audit-container">
    <!-- Sidebar with Step Progress -->
    <aside class="simulator-sidebar">
      <div class="sidebar-steps">
        @for (step of steps; track step.number) {
        <div
          class="sidebar-step-item"
          [class.active]="currentStep() === step.number"
          [class.clickable]="isStepClickable(step.number) && !step.isResult"
          [class.disabled]="!isStepClickable(step.number) && !step.isResult"
          (click)="!step.isResult && goToStep(step.number)"
        >
          @if (!step.isResult) {
          <app-ui-progress-bar
            [step]="step.number"
            [title]="step.title"
            [progress]="stepProgress()[step.number]"
            [completed]="stepProgress()[step.number] === 100"
            [isFocused]="currentStep() === step.number"
            class="sidebar-progress-bar"
          >
          </app-ui-progress-bar>
          } @else {
          <!-- Result step - matches progress bar layout but without progress bar -->
          <div
            class="sidebar-result-step"
            [class.active]="currentStep() === step.number"
            [class.disabled]="true"
          >
            <div class="sidebar-result-step-left">
              <div
                class="sidebar-step-circle result"
                [class.active]="currentStep() === step.number"
              >
                <span class="step-number">{{ step.number }}</span>
              </div>
            </div>
            <div class="sidebar-result-step-right">
              <h3 class="sidebar-step-title">{{ step.title }}</h3>
            </div>
          </div>
          }
        </div>
        }
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="simulator-main">
      <!-- Fixed Timeline Header -->
      <div class="form-timeline-header">
        <div class="step-progress-header">
          <span class="step-indicator">Étape {{ currentStep() }} sur {{ steps.length }}</span>
          <span class="step-completion">Progression: {{ overallProgress() }}%</span>
        </div>
        <app-ui-step-timeline [currentStep]="currentStep()" [totalSteps]="steps.length">
        </app-ui-step-timeline>
      </div>

      <!-- Scrollable Step Content Area -->
      <div class="form-content-scrollable">
        <div class="form-content">
          <!-- Dynamic Step Content -->
          <div class="step-content" [attr.data-step]="currentStep()">
            @if (currentStepData().isResult) {
            <!-- Results View - Original Audit Solaire Structure -->
            <div class="results-content" [@resultCards]>
              @if (simulationResult(); as simulation) {
              <!-- Professional Header -->
              <div class="results-header">
                <div class="header-icon">
                  <ng-icon name="lucideSun" class="sun-icon"></ng-icon>
                </div>
                <div class="header-content">
                  <h2 class="results-title">Rapport d'Audit Solaire</h2>
                  <p class="results-subtitle">
                    Analyse technique et économique de votre installation solaire
                  </p>
                  <div class="results-meta">
                    <span class="meta-item">
                      <ng-icon name="lucideCalendar" class="meta-icon"></ng-icon>
                      {{ simulation.createdAt | date : 'dd/MM/yyyy' }}
                    </span>
                    <span class="meta-item">
                      <ng-icon name="lucideMapPin" class="meta-icon"></ng-icon>
                      {{ form.get('location.address')?.value || 'Adresse non spécifiée' }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Executive Summary Cards -->
              <div class="executive-summary">
                <div class="summary-card primary">
                  <div class="card-header">
                    <div class="card-icon">
                      <ng-icon name="lucideZap"></ng-icon>
                    </div>
                    <div class="card-category">Système</div>
                  </div>
                  <div class="card-content">
                    <div class="card-value">
                      {{ (simulation.mtTheoreticalPVPower ?? simulation.systemSize_kWp) | number:'1.1-1' }} <span class="unit">kWc</span>
                    </div>
                    <div class="card-label">Puissance Installée</div>
                    <div class="card-description">{{ simulation.mtTheoreticalPVPower != null ? 'Capacité selon T_couv ' : 'Capacité solaire optimale' }}</div>
                  </div>
                  <div class="card-accent"></div>
                </div>

                <div class="summary-card success">
                  <div class="card-header">
                    <div class="card-icon">
                      <ng-icon name="lucideSun"></ng-icon>
                    </div>
                    <div class="card-category">Production</div>
                  </div>
                  <div class="card-content">
                    <div class="card-value">
                      {{ ((simulation.mtAnnualPVProduction ?? simulation.expectedProduction) / 1000) | number:'1.0-0' }}
                      <span class="unit">MWh</span>
                    </div>
                    <div class="card-label">Production Annuelle</div>
                    <div class="card-description">
                      {{ (simulation.mtAnnualPVProduction ?? simulation.expectedProduction) | number:'1.0-0' }}
                      kWh/an
                    </div>
                  </div>
                  <div class="card-accent"></div>
                </div>

                <div class="summary-card info">
                  <div class="card-header">
                    <div class="card-category">Économies</div>
                  </div>
                  <div class="card-content">
                    <div class="card-value">
                      @if (simulation.mtSelfConsumedEnergy != null && simulation.annualConsumption > 0) {
                        {{ ((simulation.mtSelfConsumedEnergy * (simulation.annualBillWithoutPV / simulation.annualConsumption)) / 1000) | number:'1.0-0' }}
                      } @else {
                        {{ (simulation.annualSavings / 1000) | noGrouping:'1.0-0' }}
                      }
                      <span class="unit">k DT</span>
                    </div>
                    <div class="card-label">Économies Annuelles{{ simulation.mtSelfConsumedEnergy == null ? ' (1ᵉʳᵉ année)' : '' }}</div>
                    <div class="card-description">
                      @if (simulation.mtSelfConsumedEnergy != null && simulation.annualConsumption > 0) {
                        {{ (simulation.mtSelfConsumedEnergy * (simulation.annualBillWithoutPV / simulation.annualConsumption)) | number:'1.0-0' }}
                      } @else {
                        {{ simulation.annualSavings | noGrouping:'1.0-0' }}
                      }
                      DT/an
                    </div>
                  </div>
                  <div class="card-accent"></div>
                </div>

                <div
                  class="summary-card warning"
                  [class]="
                    simulation.paybackMonths <= 84
                      ? 'success'
                      : simulation.paybackMonths <= 120
                      ? 'warning'
                      : 'danger'
                  "
                >
                  <div class="card-header">
                    <div class="card-icon">
                      <ng-icon name="lucideClock"></ng-icon>
                    </div>
                    <div class="card-category">TEMPS</div>
                  </div>
                  <div class="card-content">
                    <div class="card-value">
                      {{ formatPaybackPeriod(simulation.paybackMonths) }}
                    </div>
                    <div class="card-label">Temps de Retour sur Investissement</div>
                    <div class="card-description">Période de remboursement</div>
                  </div>
                  <div class="card-accent"></div>
                </div>

                @if (simulation.mtSelfConsumedEnergy != null) {
                <div class="summary-card mt-autoconsumption">
                  <div class="card-header">
                    <div class="card-icon">
                      <ng-icon name="lucideZap"></ng-icon>
                    </div>
                    <div class="card-category">MT</div>
                  </div>
                  <div class="card-content">
                    <div class="card-value">
                      {{ simulation.mtSelfConsumedEnergy | noGrouping:'1.0-0' }}
                      <span class="unit">kWh/an</span>
                    </div>
                    <div class="card-label">Énergie auto consommée</div>
                    <div class="card-description">Autoconsommation annuelle </div>
                  </div>
                  <div class="card-accent"></div>
                </div>
                }

                @if (simulation.mtGridSurplus != null) {
                <div class="summary-card mt-surplus">
                  <div class="card-header">
                    <div class="card-icon">
                      <ng-icon name="lucideSun"></ng-icon>
                    </div>
                    <div class="card-category">MT</div>
                  </div>
                  <div class="card-content">
                    <div class="card-value">
                      {{ simulation.mtGridSurplus | noGrouping:'1.0-0' }}
                      <span class="unit">kWh/an</span>
                    </div>
                    <div class="card-label">Excédent annuel</div>
                    <div class="card-description">Surplus injecté au réseau </div>
                  </div>
                  <div class="card-accent"></div>
                </div>
                }
              </div>

              <!-- Cost Comparison Section -->
              <div class="analysis-section">
                <div class="section-header">
                  <h3 class="section-title">
                    <ng-icon name="lucideBarChart3" class="section-icon"></ng-icon>
                    Comparaison des Coûts Annuels
                  </h3>
                  <p class="section-description">
                    Impact sur votre facture d'électricité après installation solaire
                  </p>
                </div>

                <div class="cost-comparison-grid">
                  <!-- Situation Actuelle -->
                  <div class="comparison-card current-situation">
                    <div class="comparison-header">
                      <div class="comparison-icon current">
                        <ng-icon name="lucideZap"></ng-icon>
                      </div>
                      <div class="comparison-badge">Avant</div>
                    </div>
                    <div class="comparison-content">
                      <div class="comparison-value warning">
                        {{ simulation.annualBillWithoutPV | noGrouping : '1.0-0' }}
                        <span class="currency">DT</span>
                      </div>
                      <div class="comparison-label">Situation Actuelle</div>
                      <div class="comparison-details">
                        <div class="detail-item">
                          <ng-icon name="lucideActivity" class="detail-icon"></ng-icon>
                          <span>Consommation : {{ simulation.annualConsumption | noGrouping:'1.0-0' }} kWh/an</span>
                        </div>
                      </div>
                    </div>
                    <div class="comparison-accent"></div>
                  </div>

                  <!-- Flèche animée -->
                  <div class="comparison-transition">
                    <div class="transition-arrow">
                      <ng-icon name="lucideArrowRight" class="transition-icon"></ng-icon>
                      <div class="transition-label">Installation Solaire</div>
                      @if (simulation.mtActualCoverageRate != null && simulation.mtSurplusFraction != null) {
                      <div class="transition-details">
                        avec couverture = {{ (simulation.mtActualCoverageRate * 100) | number:'1.1-1' }}% et excedent = {{ (simulation.mtSurplusFraction * 100) | number:'1.1-1' }}%
                      </div>
                      }
                    </div>
                    <div class="savings-indicator">
                      <div class="savings-amount">
                        @if (simulation.mtSelfConsumedEnergy != null && simulation.annualConsumption > 0) {
                          -{{ (simulation.mtSelfConsumedEnergy * (simulation.annualBillWithoutPV / simulation.annualConsumption)) | number:'1.0-0' }}
                        } @else {
                          -{{ simulation.annualSavings | noGrouping:'1.0-0' }}
                        }
                        DT
                      </div>
                      <div class="savings-label">Économies annuelles{{ simulation.mtSelfConsumedEnergy == null ? ' (1ᵉʳᵉ année)' : '' }}</div>
                    </div>
                  </div>

                  <!-- Avec Panneaux Solaires -->
                  <div class="comparison-card solar-situation">
                    <div class="comparison-header">
                      <div class="comparison-icon solar">
                        <ng-icon name="lucideSun"></ng-icon>
                      </div>
                      <div class="comparison-badge">Après</div>
                    </div>
                    <div class="comparison-content">
                      <div class="comparison-value success">
                        @if (simulation.mtSelfConsumedEnergy != null && simulation.annualConsumption > 0) {
                          {{ (simulation.annualBillWithoutPV - (simulation.mtSelfConsumedEnergy * (simulation.annualBillWithoutPV / simulation.annualConsumption))) | number:'1.0-0' }}
                        } @else {
                          -{{ simulation.annualSavings | noGrouping:'1.0-0' }}
                        }
                        <span class="currency">DT</span>
                      </div>
                      <div class="comparison-label">Avec Panneaux Solaires</div>
                      <div class="comparison-subtitle">Économies annuelles{{ simulation.mtSelfConsumedEnergy == null ? ' (1ᵉʳᵉ année)' : '' }}</div>
                      <div class="comparison-details">
                        <div class="detail-item">
                          <ng-icon name="lucideZap" class="detail-icon"></ng-icon>
                          <span>Énergie auto consommée :
                            @if (simulation.mtSelfConsumedEnergy != null) {
                              {{ simulation.mtSelfConsumedEnergy | number:'1.0-0' }} kWh/an
                            } @else {
                              —
                            }
                          </span>
                        </div>
                        @if (simulation.mtSelfConsumedEnergy == null) {
                        <div class="detail-item">
                          <ng-icon name="lucideZap" class="detail-icon"></ng-icon>
                          <span>Couverture: {{ simulation.coverage | number:'1.1-1' }}%</span>
                        </div>
                        <div class="detail-item">
                          <ng-icon name="lucideSun" class="detail-icon"></ng-icon>
                          <span>{{ (simulation.expectedProduction / 1000) | number:'1.1-1' }} MWh/an produits</span>
                        </div>
                        }
                      </div>
                    </div>
                    <div class="comparison-accent"></div>
                  </div>
                </div>
              </div>

              <!-- Economic Analysis -->
              <div class="analysis-section">
                <div class="section-header">
                  <h3 class="section-title">
                    <ng-icon name="lucideTrendingUp" class="section-icon"></ng-icon>
                    Analyse Économique Détaillée
                  </h3>
                  <p class="section-description">
                    Résultats financiers sur 25 ans d'exploitation solaire
                  </p>
                </div>

                <div class="economic-metrics-grid">
                  <!-- CAPEX -->
                  <div class="metric-item capex-card">
                    <div class="metric-header">
                      <div class="metric-icon capex">
                        <ng-icon name="lucideWallet"></ng-icon>
                      </div>
                      <div class="metric-badge">Investissement</div>
                    </div>
                    <div class="metric-content">
                      <div class="metric-value primary">
                        {{ simulation.installationCost | noGrouping : '1.0-0' }}
                      </div>
                      <div class="metric-label">CAPEX</div>
                      <div class="metric-subtitle">Coût d'investissement</div>
                    </div>
                  </div>

                  <!-- OPEX -->
                  <div class="metric-item opex-card">
                    <div class="metric-header">
                      <div class="metric-icon opex">
                        <ng-icon name="lucideSettings"></ng-icon>
                      </div>
                      <div class="metric-badge">Maintenance</div>
                    </div>
                    <div class="metric-content">
                      <div class="metric-value neutral">
                        {{ simulation.annualOpex | noGrouping : '1.0-0' }}
                      </div>
                      <div class="metric-label">OPEX</div>
                      <div class="metric-subtitle">Coût de maintenance annuel</div>
                    </div>
                  </div>

                  <!-- ROI -->
                  <div class="metric-item roi-card">
                    <div class="metric-header">
                      <div class="metric-icon roi">
                        <ng-icon name="lucideTrendingUp"></ng-icon>
                      </div>
                      <div class="metric-badge">Profit</div>
                    </div>
                    <div class="metric-content">
                      <div class="metric-value success">
                        {{ simulation.roi25Years || 0 | noGrouping : '1.2-2' }}
                      </div>
                      <div class="metric-label">ROI</div>
                      <div class="metric-subtitle">Retour sur investissement</div>
                    </div>
                  </div>

                  <!-- Gain cumulé non actualisé -->
                  @if (simulation.annualEconomics && simulation.annualEconomics.length > 0) {
                  <div class="metric-item gain-cumule-card">
                    <div class="metric-header">
                      <div class="metric-icon gain-cumule">
                        <ng-icon name="lucideBarChart3"></ng-icon>
                      </div>
                      <div class="metric-badge">Cumulé</div>
                    </div>
                    <div class="metric-content">
                      <div class="metric-value success">
                        {{
                          simulation.annualEconomics[simulation.annualEconomics.length - 1]!
                            .cumulativeNetGain | noGrouping : '1.0-0'
                        }}
                      </div>
                      <div class="metric-label">Gain cumulé</div>
                      <div class="metric-subtitle">Non actualisé (25 ans)</div>
                    </div>
                  </div>
                  }

                  <!-- TRI (Internal Rate of Return) - backend returns percent (e.g. 15.2) -->
                  <div class="metric-item tri-card">
                    <div class="metric-header">
                      <div class="metric-icon tri">
                        <ng-icon name="lucidePercent"></ng-icon>
                      </div>
                      <div class="metric-badge">TRI</div>
                    </div>
                    <div class="metric-content">
                      <div class="metric-value success">
                        {{ simulation.irr | noGrouping : '1.1-1' }}<span class="unit">%</span>
                      </div>
                      <div class="metric-label">Taux de Rendement Interne</div>
                      <div class="metric-subtitle">Retour sur investissement annuel</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Monthly Bills Chart – linked to backend monthlyEconomics (hidden for MT simulations) -->
              @if (simulation.monthlyEconomics && simulation.monthlyEconomics.length > 0 && simulation.mtSelfConsumedEnergy == null) {
              <div class="monthly-bills-chart">
                <div class="chart-header">
                  <h4 class="chart-title">Factures mensuelles – Avec / Sans solaire</h4>
                  <div class="chart-unit">DT/MOIS</div>
                </div>
                <div class="chart-container">
                  <div class="chart-y-axis">
                    @for (tick of getChartYAxisTicks(); track $index) {
                    <div class="y-axis-label">{{ tick | noGrouping : '1.0-0' }}</div>
                    }
                  </div>
                  <div class="chart-bars-container">
                    <div class="chart-bars-wrapper">
                      <div class="chart-bars">
                        @for (month of simulation.monthlyEconomics; track month.month; let i =
                        $index) {
                        <div class="chart-month">
                          <div class="chart-bars-pair">
                            @if (monthlyBillsTooltip()?.monthIndex === i &&
                            monthlyBillsTooltip()?.bar === 'sans') {
                            <div class="monthly-bills-tooltip monthly-bills-tooltip-stacked">
                              <div class="monthly-bills-tooltip-month">
                                {{ monthlyBillsTooltip()!.monthLabel }}
                              </div>
                              <div
                                class="monthly-bills-tooltip-bubble monthly-bills-tooltip-bubble-sans"
                              >
                                Sans solaire:
                                {{ monthlyBillsTooltip()!.billWithoutPV | noGrouping : '1.0-0' }} DT
                              </div>
                            </div>
                            } @if (monthlyBillsTooltip()?.monthIndex === i &&
                            monthlyBillsTooltip()?.bar === 'avec') {
                            <div class="monthly-bills-tooltip monthly-bills-tooltip-stacked">
                              <div class="monthly-bills-tooltip-month">
                                {{ monthlyBillsTooltip()!.monthLabel }}
                              </div>
                              <div
                                class="monthly-bills-tooltip-bubble monthly-bills-tooltip-bubble-avec"
                              >
                                Avec solaire:
                                {{ monthlyBillsTooltip()!.billWithPV | noGrouping : '1.0-0' }} DT
                              </div>
                            </div>
                            }
                            <div
                              class="chart-bar chart-bar-without"
                              [class.chart-bar-zero]="month.billWithoutPV === 0"
                              [style.height.%]="getBarHeight(month.billWithoutPV)"
                              (mouseenter)="onMonthlyBarHover(i, month, 'sans')"
                              (mouseleave)="onMonthlyBarLeave()"
                            ></div>
                            <div
                              class="chart-bar chart-bar-with"
                              [class.chart-bar-zero]="month.billWithPV === 0"
                              [style.height.%]="getBarHeight(month.billWithPV)"
                              (mouseenter)="onMonthlyBarHover(i, month, 'avec')"
                              (mouseleave)="onMonthlyBarLeave()"
                            ></div>
                          </div>
                        </div>
                        }
                      </div>
                      <div class="chart-labels-row">
                        @for (month of simulation.monthlyEconomics; track month.month; let i =
                        $index) {
                        <div class="chart-month-label">{{ getMonthLabel(i) }}</div>
                        }
                      </div>
                    </div>
                    <div class="chart-legend">
                      <div class="chart-legend-item">
                        <span class="chart-swatch chart-swatch-without"></span>
                        <span>Facture sans solaire</span>
                      </div>
                      <div class="chart-legend-item">
                        <span class="chart-swatch chart-swatch-with"></span>
                        <span>Facture avec solaire</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              }

              <!-- Cumulative Gains vs CAPEX Chart – linked to backend annualEconomics -->
              @if (simulation.annualEconomics && simulation.annualEconomics.length > 0) {
              <div class="analysis-section cumulative-gains-section">
                <div class="cumulative-gains-chart">
                  <div class="chart-header">
                    <div class="chart-title">Gains nets cumulés vs CAPEX</div>
                    <div class="chart-unit">DT</div>
                  </div>
                  <div class="line-chart-container">
                    <div class="line-chart-y-axis">
                      @for (tick of getLineChartYAxisTicks(); track tick; let i = $index) {
                      <div class="y-axis-label">{{ tick | noGrouping : '1.0-0' }}</div>
                      }
                    </div>
                    <div class="line-chart-content">
                      <div
                        #lineChartSvgContainer
                        class="line-chart-svg-container"
                        (mouseleave)="onChartMouseLeave()"
                      >
                        @if (chartTooltip(); as tt) {
                        <div
                          class="chart-tooltip chart-tooltip-stacked"
                          [style.left.px]="tt.bubbleLocalX"
                          [style.top.px]="tt.bubbleLocalY"
                          style="transform: translate(-50%, -50%)"
                        >
                          <div class="chart-tooltip-year">Année {{ tt.year }}</div>
                          <div class="chart-tooltip-bubble chart-tooltip-bubble-gains">
                            {{ tt.gains | noGrouping : '1.0-0' }} DT
                          </div>
                          <div class="chart-tooltip-bubble chart-tooltip-bubble-capex">
                            {{ tt.capex | noGrouping : '1.0-0' }} DT
                          </div>
                        </div>
                        }
                        <svg
                          #lineChartSvg
                          class="line-chart-svg"
                          viewBox="0 0 1000 400"
                          preserveAspectRatio="none"
                          style="overflow: visible"
                          (mousemove)="onChartMouseMove($event)"
                        >
                          <defs>
                            <linearGradient id="chartGradientGains" x1="0" x2="0" y1="1" y2="0">
                              <stop offset="0%" stop-color="#3b82f6" stop-opacity="0.22" />
                              <stop offset="100%" stop-color="#3b82f6" stop-opacity="0" />
                            </linearGradient>
                            <linearGradient id="chartGradientCapex" x1="0" x2="0" y1="1" y2="0">
                              <stop offset="0%" stop-color="#f97316" stop-opacity="0.2" />
                              <stop offset="100%" stop-color="#f97316" stop-opacity="0" />
                            </linearGradient>
                            <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                              <feGaussianBlur in="SourceAlpha" stdDeviation="3" />
                              <feOffset dx="2" dy="2" result="offsetblur" />
                              <feComponentTransfer>
                                <feFuncA type="linear" slope="0.3" />
                              </feComponentTransfer>
                              <feMerge>
                                <feMergeNode />
                                <feMergeNode in="SourceGraphic" />
                              </feMerge>
                            </filter>
                          </defs>
                          @if (getGainsAreaPath()) {
                          <path
                            [attr.d]="getGainsAreaPath()"
                            fill="url(#chartGradientGains)"
                            class="chart-area-gains"
                          />
                          } @if (getCapexAreaPath()) {
                          <path
                            [attr.d]="getCapexAreaPath()"
                            fill="url(#chartGradientCapex)"
                            class="chart-area-capex"
                          />
                          }
                          <polyline
                            class="line-capex"
                            [attr.points]="getCapexLinePoints()"
                            fill="none"
                            stroke="rgba(249, 115, 22, 0.9)"
                            stroke-width="2.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-dasharray="8,4"
                          />
                          @for (point of getCapexLinePointsArray(); track $index) {
                          <circle
                            class="chart-marker chart-marker-capex"
                            [attr.cx]="point.x"
                            [attr.cy]="point.y"
                            r="3.5"
                          />
                          }
                          <polyline
                            class="line-gains"
                            [attr.points]="getGainsLinePoints()"
                            fill="none"
                            stroke="rgba(59, 130, 246, 0.9)"
                            stroke-width="2.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                          @for (point of getGainsLinePointsArray(); track $index) {
                          <circle
                            class="chart-marker chart-marker-gains"
                            [attr.cx]="point.x"
                            [attr.cy]="point.y"
                            r="3.5"
                          />
                          } @if (getIntersectionPoint(); as pt) {
                          <g>
                            <circle
                              [attr.cx]="pt.x"
                              [attr.cy]="pt.y"
                              r="8"
                              fill="#10b981"
                              stroke="white"
                              stroke-width="3"
                            />
                            <rect
                              [attr.x]="getIntersectionBubbleX()"
                              [attr.y]="pt.y - 45"
                              [attr.width]="getIntersectionBubbleWidth()"
                              height="35"
                              rx="10"
                              fill="#10b981"
                              stroke="#059669"
                              stroke-width="2"
                              opacity="0.95"
                              filter="url(#shadow)"
                            />
                            <text
                              [attr.x]="pt.x"
                              [attr.y]="pt.y - 25"
                              text-anchor="middle"
                              font-size="14"
                              font-weight="bold"
                              fill="#ffffff"
                            >
                              {{ formatPaybackPeriod(simulation.paybackMonths) }}
                            </text>
                          </g>
                          } @if (getFinalGainsPoint(); as fp) { @if (getFinalGainsValue() !== null
                          && getFinalGainsValue()! > 0) {
                          <g>
                            <circle
                              [attr.cx]="fp.x"
                              [attr.cy]="fp.y"
                              r="8"
                              fill="#3b82f6"
                              stroke="white"
                              stroke-width="3"
                            />
                            <line
                              [attr.x1]="fp.x"
                              [attr.y1]="fp.y"
                              [attr.x2]="fp.x - 95"
                              [attr.y2]="fp.y + 50"
                              stroke="rgba(59, 130, 246, 0.9)"
                              stroke-width="3"
                              stroke-linecap="round"
                            />
                            <rect
                              [attr.x]="getFinalGainsBubbleX()"
                              [attr.y]="fp.y + 20"
                              [attr.width]="getFinalGainsBubbleWidth()"
                              height="40"
                              rx="12"
                              fill="#ffffff"
                              stroke="#3b82f6"
                              stroke-width="3"
                              opacity="0.97"
                              filter="url(#shadow)"
                            />
                            <text
                              [attr.x]="getFinalGainsTextX()"
                              [attr.y]="fp.y + 46"
                              text-anchor="middle"
                              font-size="14"
                              font-weight="bold"
                              fill="#1e40af"
                            >
                              {{ getFinalGainsValue() | noGrouping : '1.0-0' }} DT
                            </text>
                          </g>
                          } } @if (getFinalCapexPoint(); as cp) { @if (getFinalCapexValue() !== null
                          && getFinalCapexValue()! > 0) {
                          <g>
                            <circle
                              [attr.cx]="cp.x"
                              [attr.cy]="cp.y"
                              r="8"
                              fill="#f97316"
                              stroke="white"
                              stroke-width="3"
                            />
                            <line
                              [attr.x1]="cp.x"
                              [attr.y1]="cp.y"
                              [attr.x2]="cp.x - 95"
                              [attr.y2]="cp.y - 28"
                              stroke="rgba(249, 115, 22, 0.9)"
                              stroke-width="3"
                              stroke-linecap="round"
                            />
                            <rect
                              [attr.x]="getFinalCapexBubbleX()"
                              [attr.y]="cp.y - 50"
                              [attr.width]="getFinalCapexBubbleWidth()"
                              height="40"
                              rx="12"
                              fill="#ffffff"
                              stroke="#f97316"
                              stroke-width="3"
                              opacity="0.97"
                              filter="url(#shadow)"
                            />
                            <text
                              [attr.x]="getFinalCapexTextX()"
                              [attr.y]="cp.y - 24"
                              text-anchor="middle"
                              font-size="14"
                              font-weight="bold"
                              fill="#c2410c"
                            >
                              {{ getFinalCapexValue() | noGrouping : '1.0-0' }} DT
                            </text>
                          </g>
                          } }
                        </svg>
                      </div>
                      <div class="line-chart-x-axis line-chart-x-axis-sparse">
                        @for (year of getSparseChartYears(); track year) {
                        <div class="x-axis-label">Année {{ year }}</div>
                        }
                      </div>
                    </div>
                  </div>
                  <div class="line-chart-legend">
                    <div class="legend-item">
                      <div class="legend-line legend-line-gains"></div>
                      <span>Gains nets cumulés</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-line legend-line-capex"></div>
                      <span>CAPEX</span>
                    </div>
                  </div>
                </div>
              </div>
              }

              <!-- Environmental Impact -->
              <div class="analysis-section">
                <div class="section-header">
                  <h3 class="section-title">
                    <ng-icon name="lucideLeaf" class="section-icon"></ng-icon>
                    Impact Environnemental
                  </h3>
                  <p class="section-description">
                    Réduction des émissions de CO₂ grâce à votre installation solaire
                  </p>
                </div>

                <div class="environmental-metrics-grid">
                  <!-- CO₂ évité (annuel) – backend sends kg, display in tonnes -->
                  <div class="environmental-item co2-annual-card">
                    <div class="environmental-header">
                      <div class="environmental-icon co2-annual">
                        <ng-icon name="lucideCloud"></ng-icon>
                      </div>
                      <div class="environmental-badge">Annuel</div>
                    </div>
                    <div class="environmental-content">
                      <div class="environmental-value success">
                        {{ simulation.annualCo2Avoided | noGrouping : '1.1-1' }}
                        <span class="unit">tonnes</span>
                      </div>
                      <div class="environmental-label">CO₂ évité</div>
                      <div class="environmental-subtitle">Émissions de carbone réduites par an</div>
                    </div>
                  </div>

                  <!-- CO₂ évité total (25 ans) – backend sends kg, display in tonnes -->
                  <div class="environmental-item co2-total-card">
                    <div class="environmental-header">
                      <div class="environmental-icon co2-total">
                        <ng-icon name="lucideTreePine"></ng-icon>
                      </div>
                      <div class="environmental-badge">25 ans</div>
                    </div>
                    <div class="environmental-content">
                      <div class="environmental-value success">
                        {{ simulation.totalCo2Avoided25Years | noGrouping : '1.0-0' }}
                        <span class="unit">tonnes</span>
                      </div>
                      <div class="environmental-label">CO₂ évité total</div>
                      <div class="environmental-subtitle">
                        Émissions cumulées sur la durée de vie
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Recommendations -->
              <div class="analysis-section">
                <h3 class="section-title" style="margin-bottom: 2rem">
                  <ng-icon
                    name="lucideLightbulb"
                    class="section-icon"
                    style="margin-bottom: 2 rem"
                  ></ng-icon>
                  Prochaines Étapes Recommandées
                </h3>

                <div class="recommendations">
                  <div class="recommendation-item">
                    <div class="recommendation-icon">
                      <ng-icon name="lucidePhone"></ng-icon>
                    </div>
                    <div class="recommendation-content">
                      <h4>Contactez notre équipe</h4>
                      <p>Obtenez un devis personnalisé et détaillé pour votre installation</p>
                    </div>
                  </div>

                  <div class="recommendation-item">
                    <div class="recommendation-icon">
                      <ng-icon name="lucideFileText"></ng-icon>
                    </div>
                    <div class="recommendation-content">
                      <h4>Étude de faisabilité</h4>
                      <p>Visite technique gratuite pour valider l'installation sur site</p>
                    </div>
                  </div>

                  <div class="recommendation-item">
                    <div class="recommendation-icon">
                      <ng-icon name="lucideCreditCard"></ng-icon>
                    </div>
                    <div class="recommendation-content">
                      <h4>Options de financement</h4>
                      <p>Solutions de paiement échelonnées et aides financières disponibles</p>
                    </div>
                  </div>
                </div>
              </div>
              } @else {
              <div class="loading-state">
                <div class="loading-content">
                  <div class="loading-spinner">
                    <ng-icon name="lucideZap" class="spinning"></ng-icon>
                  </div>
                  <h3>Analyse en cours...</h3>
                  <p>Nous calculons votre solution solaire optimale</p>
                </div>
              </div>
              }
            </div>
            } @else {
            <!-- Form Fields -->
            <form [formGroup]="form" class="simulator-form">
              <div class="simulator-form-header">
                <h3 class="simulator-form-title">Calculateur Audit Solaire</h3>
                <h2 class="step-title">{{ currentStepData().title }}</h2>
                @if (currentStepData().description) {
                <p class="step-description">{{ currentStepData().description }}</p>
                }
              </div>

              <!-- Step 1: Invoice & consumption -->
              @if (currentStep() === 1) {
              <div [@stepTransition]="currentStep()">
                <!-- Bill Upload Feature - Temporarily Disabled -->
                <!--
                    <div class="form-field" formGroupName="consumption">
                      <app-ui-select
                        formControlName="hasInvoice"
                        [options]="invoiceOptions"
                        label="Avez-vous une facture d'électricité récente ?"
                        placeholder="Sélectionnez une option"
                        [required]="true"
                        variant="box"
                        [columns]="2">
                      </app-ui-select>
                    </div>

                    @if (invoiceChoice() === 'yes') {
                      <div class="upload-section">
                        <app-upload-card
                          [config]="uploadCardConfig"
                          [selectedFile]="form.get('consumption.billAttachment')?.value"
                          (fileSelected)="onBillSelected($event)"
                          (extractClicked)="onExtractFromBill()"
                          (manualEntryClicked)="onManualEntry()">
                        </app-upload-card>
                      </div>
                    }

                    @if (invoiceChoice() === 'no') {
                    -->

                <!-- Simulator Description -->
                <div class="simulator-description">
                  <p>
                    Ce simulateur analyse votre consommation énergétique et calcule le potentiel
                    solaire de votre bâtiment. Il vous fournira une estimation détaillée de la
                    production photovoltaïque, des économies réalisables, et des indicateurs
                    financiers (ROI, période de retour sur investissement, NPV).
                  </p>
                  <p>
                    Pour obtenir des résultats précis, veuillez renseigner le montant de votre
                    dernière facture d'électricité et le mois de référence correspondant.
                  </p>
                </div>

                <!-- Manual entry form -->
                <div class="manual-entry-section" formGroupName="consumption">
                  <div class="form-grid">
                    <!-- Monthly Amount -->
                    <app-ui-input
                      formControlName="measuredAmountTnd"
                      type="number"
                      label="Montant mensuel (TND)"
                      placeholder="Ex: 2500"
                      [required]="true"
                      icon="lucideZap"
                      tooltipTitle="Facture"
                      tooltipDescription="Montant total de votre dernière facture d'électricité."
                      size="md">
                    </app-ui-input>

                    <!-- Reference Month -->
                    <div class="form-field">
                      <app-ui-select
                        formControlName="referenceMonth"
                        [options]="monthLabels()"
                        label="Mois de référence"
                        placeholder="Sélectionnez le mois"
                        [required]="true"
                        variant="dropdown">
                      </app-ui-select>
                      <app-field-tooltip
                        title="Mois"
                        description="Mois durant lequel la facture a été établie."
                        class="field-tooltip-inline">
                      </app-field-tooltip>
                    </div>
                  </div>

                  <!-- Régime tarifaire (BT / MT) -->
                  <div class="tariff-section">
                    <div class="field-label">Régime tarifaire</div>
                    <div class="tariff-toggle-group">
                      <button
                        type="button"
                        class="tariff-toggle"
                        [class.tariff-toggle--active]="form.get('consumption.tariffTension')?.value === 'BT'"
                        (click)="form.get('consumption.tariffTension')?.setValue('BT')">
                        Basse Tension
                      </button>
                      <button
                        type="button"
                        class="tariff-toggle"
                        [class.tariff-toggle--active]="form.get('consumption.tariffTension')?.value === 'MT'"
                        (click)="form.get('consumption.tariffTension')?.setValue('MT')">
                        Moyenne Tension
                      </button>
                    </div>
                  </div>

                  @if (form.get('consumption.tariffTension')?.value === 'MT') {
                  <div #mtOptionsContainer class="tariff-row">
                    <!-- Horaire de fonctionnement (only for MT) -->
                    <div class="tariff-section">
                      <div class="field-label">Horaire de fonctionnement</div>
                      <div class="tariff-toggle-group">
                        <button
                          type="button"
                          class="tariff-toggle"
                          [class.tariff-toggle--active]="form.get('consumption.operatingHoursCase')?.value === 'jour'"
                          (click)="form.get('consumption.operatingHoursCase')?.setValue('jour')">
                          Jour
                        </button>
                        <button
                          type="button"
                          class="tariff-toggle"
                          [class.tariff-toggle--active]="form.get('consumption.operatingHoursCase')?.value === '24_7'"
                          (click)="form.get('consumption.operatingHoursCase')?.setValue('24_7')">
                          24/24
                        </button>
                        <button
                          type="button"
                          class="tariff-toggle"
                          [class.tariff-toggle--active]="form.get('consumption.operatingHoursCase')?.value === 'jour_soir'"
                          (click)="form.get('consumption.operatingHoursCase')?.setValue('jour_soir')">
                          Jour + soir
                        </button>
                      </div>
                    </div>

                    <!-- Régime (only for MT) -->
                    <div class="tariff-section">
                      <div class="field-label">Régime</div>
                      <div class="tariff-toggle-group">
                        <button
                          type="button"
                          class="tariff-toggle"
                          [class.tariff-toggle--active]="form.get('consumption.tariffRegime')?.value === 'uniforme'"
                          (click)="form.get('consumption.tariffRegime')?.setValue('uniforme')">
                          Tarif uniforme
                        </button>
                        <button
                          type="button"
                          class="tariff-toggle"
                          [class.tariff-toggle--active]="form.get('consumption.tariffRegime')?.value === 'horaire'"
                          (click)="form.get('consumption.tariffRegime')?.setValue('horaire')">
                          Tarif horaire
                        </button>
                      </div>
                    </div>
                  </div>
                  }
                </div>
                <!--
                    }
                    -->
              </div>
              }

              <!-- Step 2: Building -->
              @if (currentStep() === 2) {
              <div [@stepTransition]="currentStep()">
                <div class="building-type-selection" formGroupName="building">
                  <div class="form-field">
                    <app-ui-select
                      formControlName="buildingType"
                      label="Type de bâtiment"
                      [required]="true"
                      [options]="buildingTypeOptionsForSelect"
                      placeholder="Sélectionnez le type de bâtiment"
                      variant="dropdown-icon"
                    >
                    </app-ui-select>
                  </div>

                  <div class="form-field" style="margin-bottom: 4rem">
                    <label class="field-label">Zone climatique</label>
                    <app-ui-select
                      variant="box"
                      [options]="climateZones"
                      placeholder="Sélectionnez la zone"
                      [formControlName]="'climateZone'"
                    >
                    </app-ui-select>
                  </div>
                </div>
              </div>
              }

              <!-- Step 3: Personal Info & Location -->
              @if (currentStep() === 3) {
              <div [@stepTransition]="currentStep()">
                <!-- Personal Information Fields -->
                <div class="form-grid" formGroupName="personal">
                  <app-ui-input
                    formControlName="fullName"
                    type="text"
                    label="Nom complet"
                    placeholder="Entrez votre nom complet"
                    [required]="true"
                    tooltipTitle="Nom complet"
                    tooltipDescription="Personne référente pour l'audit."
                    size="md"
                  >
                  </app-ui-input>

                  <app-ui-input
                    formControlName="companyName"
                    type="text"
                    label="Entreprise"
                    placeholder="Entrez le nom de l'entreprise"
                    [required]="true"
                    tooltipTitle="Raison sociale"
                    tooltipDescription="Nom légal ou enseigne du site."
                    size="md"
                  >
                  </app-ui-input>

                  <app-ui-input
                    formControlName="email"
                    type="text"
                    label="Email"
                    placeholder="email@example.com"
                    [required]="true"
                    tooltipTitle="Email de contact"
                    tooltipDescription="Adresse utilisée pour l'envoi des résultats."
                    size="md"
                  >
                  </app-ui-input>

                  <app-ui-input
                    formControlName="phoneNumber"
                    type="text"
                    label="Téléphone"
                    placeholder="Entrez votre numéro de téléphone"
                    [required]="true"
                    tooltipTitle="Téléphone"
                    tooltipDescription="Numéro pour les échanges techniques."
                    size="md"
                  >
                  </app-ui-input>
                </div>

                <!-- Location Field -->
                <div class="form-field" formGroupName="location" style="margin-top: 2rem">
                  <app-google-maps-input
                    style="margin-bottom: 4rem"
                    formControlName="address"
                    label="Adresse complète du bâtiment"
                    placeholder="Entrez l'adresse complète"
                    [required]="true"
                    size="md"
                    tooltipTitle="Lieu"
                    tooltipDescription="Adresse précise pour estimer l'ensoleillement."
                    (addressSelected)="onAddressChange($event)"
                  >
                  </app-google-maps-input>
                </div>
              </div>
              }
            </form>
            }
          </div>
        </div>

        <!-- Mobile Navigation Buttons Footer (scrolls with content) -->
        <div
          class="form-actions form-actions--mobile"
          [class.result-actions]="currentStepData().isResult"
        >
          @if (!currentStepData().isResult) {
          <button
            type="button"
            class="hero__btn hero__btn--outline"
            [disabled]="!canGoBack()"
            (click)="previousStep()"
          >
            <ng-icon name="lucideArrowLeft" size="16"></ng-icon>
            Précédent
          </button>

          @if (currentStep() < lastFormStepNumber) {
          <button
            type="button"
            class="hero__btn hero__btn--primary"
            [disabled]="isSubmitting()"
            (click)="nextStep()"
          >
            Suivant
            <ng-icon name="lucideArrowRight" size="16"></ng-icon>
          </button>
          } @else {
          <button
            type="button"
            class="hero__btn hero__btn--primary"
            [disabled]="isSubmitting()"
            (click)="nextStep()"
          >
            @if (isSubmitting()) {
            <span>Calcul en cours...</span>
            } @else {
            <span>Lancer la simulation</span>
            <ng-icon name="lucideArrowRight" size="16"></ng-icon>
            }
          </button>
          } } @else {
          <!-- Results step actions -->
          <button type="button" class="hero__btn hero__btn--outline" (click)="resetForm()">
            Nouvelle simulation
          </button>
          <button
            type="button"
            class="hero__btn hero__btn--primary"
            [disabled]="isGeneratingPDF() || !simulationResult()?.id"
            (click)="downloadPVReport()"
          >
            @if (isGeneratingPDF()) {
            <span>Génération...</span>
            } @else {
            <span>Télécharger le rapport PV</span>
            <ng-icon name="lucideDownload" size="16"></ng-icon>
            }
          </button>
          }
        </div>
      </div>

      <!-- Desktop Navigation Buttons Footer -->
      <div
        class="form-actions form-actions--desktop"
        [class.result-actions]="currentStepData().isResult"
      >
        @if (!currentStepData().isResult) {
        <button
          type="button"
          class="hero__btn hero__btn--outline"
          [disabled]="!canGoBack()"
          (click)="previousStep()"
        >
          <ng-icon name="lucideArrowLeft" size="16"></ng-icon>
          Précédent
        </button>

        @if (currentStep() < lastFormStepNumber) {
        <button
          type="button"
          class="hero__btn hero__btn--primary"
          [disabled]="isSubmitting()"
          (click)="nextStep()"
        >
          Suivant
          <ng-icon name="lucideArrowRight" size="16"></ng-icon>
        </button>
        } @else {
        <button
          type="button"
          class="hero__btn hero__btn--primary"
          [disabled]="isSubmitting()"
          (click)="nextStep()"
        >
          @if (isSubmitting()) {
          <span>Calcul en cours...</span>
          } @else {
          <span>Lancer la simulation</span>
          <ng-icon name="lucideArrowRight" size="16"></ng-icon>
          }
        </button>
        } } @else {
        <!-- Results step actions -->
        <button type="button" class="hero__btn hero__btn--outline" (click)="resetForm()">
          Nouvelle simulation
        </button>
        <button
          type="button"
          class="hero__btn hero__btn--primary"
          [disabled]="isGeneratingPDF() || !simulationResult()?.id"
          (click)="downloadPVReport()"
        >
          @if (isGeneratingPDF()) {
          <span>Génération...</span>
          } @else {
          <span>Télécharger le rapport PV</span>
          <ng-icon name="lucideDownload" size="16"></ng-icon>
          }
        </button>
        }
      </div>
    </main>
  </div>
</div>
