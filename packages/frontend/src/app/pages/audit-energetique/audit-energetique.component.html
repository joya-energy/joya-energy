<div class="audit-page">
    <main class="audit-main">
        <section class="stepper d-flex items-center justify-center gap-6">
            <div class="stepper-item d-flex items-center gap-2" [class.stepper-item--active]="step() === 1"
                [class.stepper-item--done]="step() > 1">
                <span class="stepper-index inline-flex items-center justify-center rounded-full">1</span>
                <span class="stepper-label">Import facture</span>
            </div>
            <div class="stepper-divider flex-none"></div>
            <div class="stepper-item d-flex items-center gap-2" [class.stepper-item--active]="step() === 2"
                [class.stepper-item--done]="step() > 2">
                <span class="stepper-index inline-flex items-center justify-center rounded-full">2</span>
                <span class="stepper-label">Profil b√¢timent</span>
            </div>
            <div class="stepper-divider flex-none"></div>
            <div class="stepper-item d-flex items-center gap-2" [class.stepper-item--active]="step() === 3">
                <span class="stepper-index inline-flex items-center justify-center rounded-full">3</span>
                <span class="stepper-label">Infos g√©n√©rales</span>
            </div>
            <div class="stepper-divider flex-none"></div>
            <div class="stepper-item d-flex items-center gap-2" [class.stepper-item--active]="step() === 4">
                <span class="stepper-index inline-flex items-center justify-center rounded-full">4</span>
                <span class="stepper-label">R√©sultats</span>
            </div>
        </section>

        <section class="hero" *ngIf="step() !== 4">
            <h1>Audit √ânerg√©tique</h1>
            <p>Commencez par importer votre facture STEG pour une analyse automatique</p>
        </section>

        <section class="upload-panel" *ngIf="step() === 1">
            <app-upload-card
                [config]="uploadCardConfig"
                [isExtracting]="isExtracting()"
                [selectedFile]="billFile()"
                (fileSelected)="onBillSelected($event)"
                (extractClicked)="onExtractFromBill()"
                (manualEntryClicked)="onManualEntry()">
            </app-upload-card>
        </section>

        <section class="form-sheet" *ngIf="step() === 2 || step() === 3 || step() === 4">
            <h2 *ngIf="step() !== 4">{{ formStepTitle() }}</h2>
            <h2 *ngIf="step() === 4" class="results-title">R√©sultats de votre Audit</h2>

            <div *ngIf="step() === 4 && simulationResult() as result" class="results-container">
                <div class="results-grid">
                    <!-- Energy Consumption -->
                    <div class="result-card consumption">
                        <div class="result-icon">‚ö°</div>
                        <h3>Consommation √ânerg√©tique</h3>
                            <div class="result-value">
                                <span class="amount">{{ result.results.energyConsumption.annual.value  }}</span>
                                <span class="unit">{{ result.results.energyConsumption.annual.unit }}</span>
                            </div>
                        <div class="result-subvalues">
                            <div class="subvalue">
                                    <span>Mensuel:</span>
                                    <strong>{{ result.results.energyConsumption.monthly.value  }} {{ result.results.energyConsumption.monthly.unit }}</strong>
                            </div>
                            <div class="subvalue">
                                <span>Ratio:</span>
                                    <strong>{{ result.results.energyConsumption.perSquareMeter.value }} {{ result.results.energyConsumption.perSquareMeter.unit }}</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Energy Cost -->
                    <div class="result-card cost">
                        <div class="result-icon">üí∞</div>
                        <h3>Co√ªt Estim√©</h3>
                        <div class="result-value">
                            <span class="amount">{{ result.results.energyCost.annual.value  }}</span>
                            <span class="unit">{{ result.results.energyCost.annual.unit }}</span>
                        </div>
                        <div class="result-subvalues">
                            <div class="subvalue">
                                <span>Mensuel:</span>
                                <strong>{{ result.results.energyCost.monthly.value  }} {{ result.results.energyCost.monthly.unit }}</strong>
                            </div>
                        </div>
                    </div>

                    <!-- CO2 Emissions -->
                    <div class="result-card co2">
                        <div class="result-icon">üå±</div>
                        <h3>Impact Carbone</h3>
                        <div class="result-value">
                            <span class="amount">{{ result.results.co2Emissions.annual.tons | number:'1.1-2' }}</span>
                            <span class="unit">Tonnes CO‚ÇÇ/an</span>
                        </div>
                        <div class="result-subvalues">
                            <div class="subvalue">
                                <span>Ratio:</span>
                                <strong>{{ result.results.co2Emissions.perSquareMeter.value }} {{ result.results.co2Emissions.perSquareMeter.unit }}</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Energy Classification -->
                <div class="recommendation-banner" *ngIf="result.results.energyClassification && result.results.energyClassification.isApplicable">
                    <div class="classification-badge" [ngClass]="'class-' + result.results.energyClassification.class">
                        {{ result.results.energyClassification.class }}
                    </div>
                    <div class="recommendation-text">
                        <h4>Classe √ânerg√©tique</h4>
                        <p>{{ result.results.energyClassification.description }}</p>
                        <small class="becth-value">BECTh: {{ result.results.energyClassification.becth }} kWh/m¬≤.an</small>
                    </div>
                </div>

                <!-- Carbon Classification -->
                <div class="recommendation-banner carbon-banner" *ngIf="result.results.carbonClassification && result.results.carbonClassification.isApplicable">
                    <div class="classification-badge" [ngClass]="'class-' + result.results.carbonClassification.class">
                        {{ result.results.carbonClassification.class }}
                    </div>
                    <div class="recommendation-text">
                        <h4>Classement Carbone</h4>
                        <p>{{ result.results.carbonClassification.description }}</p>
                        <small class="carbon-intensity">{{ result.results.carbonClassification.intensity }} {{ result.results.carbonClassification.unit }}</small>
                    </div>
                </div>

                <div class="form-actions result-actions">
                    <button type="button" class="pill-button pill-button--secondary" (click)="step.set(1)">
                        Nouvelle simulation
                    </button>
                    <button 
                        type="button" 
                        class="pill-button pill-button--primary"
                        (click)="downloadPDF()"
                        [disabled]="isGeneratingPDF() || !simulationResult()?.simulationId">
                        <ng-container *ngIf="!isGeneratingPDF(); else generatingLabel">
                            T√©l√©charger le rapport PDF
                        </ng-container>
                        <ng-template #generatingLabel>
                            <span class="button-loader"></span>
                            G√©n√©ration en cours...
                        </ng-template>
                    </button>
                </div>
            </div>

            <form [formGroup]="auditForm" (ngSubmit)="submitSimulation()" class="audit-form d-flex flex-col gap-8" *ngIf="step() !== 4">
                <ng-container *ngIf="step() === 3">
                    <div class="form-section" formGroupName="personal">
                        <div class="form-section-header">Informations personnelles</div>
                        <div class="form-grid">
                            <label *ngFor="let field of personalFields; trackBy: trackByField"
                                class="d-flex flex-col gap-2" [class.span-2]="field.span">
                                <span class="d-flex items-center justify-between gap-2">
                                  <span>{{ field.label }}</span>
                                  <app-field-tooltip *ngIf="field.tooltip" [title]="field.tooltip.title"
                                    [description]="field.tooltip.description ?? ''" [options]="field.tooltip.options ?? []" />
                                </span>
                                <ng-container *ngIf="!field.options?.length">
                                    <input [type]="field.type ?? 'text'" [placeholder]="field.placeholder ?? ''"
                                        [formControlName]="field.control">
                                </ng-container>
                                <ng-container *ngIf="field.options?.length">
                                    <app-ui-select [options]="field.options ?? []" [formControlName]="field.control"
                                        [placeholder]="field.placeholderOption!"
                                        [multiple]="field.multiple ?? false"></app-ui-select>
                                </ng-container>
                            </label>
                        </div>
                    </div>

                    <div class="form-section" formGroupName="consumption">
                        <div class="form-section-header">Donn√©es de consommation</div>
                        <div class="form-grid">
                            <label *ngFor="let field of consumptionFields; trackBy: trackByField"
                                class="d-flex flex-col gap-2">
                                <span class="d-flex items-center justify-between gap-2">
                                  <span>{{ field.label }}</span>
                                  <app-field-tooltip *ngIf="field.tooltip" [title]="field.tooltip.title"
                                    [description]="field.tooltip.description ?? ''" [options]="field.tooltip.options ?? []" />
                                </span>
                                <ng-container *ngIf="!field.options?.length">
                                    <input [type]="field.type ?? 'text'" [formControlName]="field.control">
                                </ng-container>
                                <ng-container *ngIf="field.options?.length">
                                    <app-ui-select [options]="field.options ?? []" [formControlName]="field.control"
                                        [placeholder]="field.placeholderOption ?? 'S√©lectionnez...'"
                                        [multiple]="field.multiple ?? false"></app-ui-select>
                                </ng-container>
                            </label>
  
                        </div>
                    </div>

                    <div class="form-actions d-flex flex-column gap-3">
                        <button type="button" class="pill-button pill-button--secondary" (click)="backToBuildingStep()">
                            <ng-icon name="lucideArrowLeft" size="16"></ng-icon>
                            Retour au b√¢timent
                        </button>
                        <button type="submit" class="pill-button pill-button--primary" [disabled]="isSubmitting()">
                            <ng-container *ngIf="isSubmitting(); else submitLabel">Calcul en cours...</ng-container>
                            <ng-template #submitLabel>
                                Voir les r√©sultats
                                <ng-icon name="lucideArrowRight" size="16"></ng-icon>
                            </ng-template>
                        </button>
                    </div>
                </ng-container>

                <ng-container *ngIf="step() === 2">
                    <div class="form-section" formGroupName="building">
                        <div class="form-section-header">Type de b√¢timent</div>
                        <div class="building-grid">
                            <button *ngFor="let type of buildingCategories; trackBy: trackByCategory" type="button"
                                class="building-card" [class.building-card--active]="buildingControls.buildingType.value === type.id"
                                (click)="selectBuildingType(type.id)">
                                <div class="building-card-icon d-flex items-center justify-center">
                                    <ng-icon [name]="type.icon"></ng-icon>
                                </div>
                                <span>{{ type.label }}</span>
                            </button>
                        </div>
                        
                        <!-- Fallback select only if needed/requested, distinct from cards -->
                        <div class="fallback-select" *ngIf="!isFeaturedBuilding(buildingControls.buildingType.value)">
                            <app-ui-select [options]="buildingTypes" formControlName="buildingType"
                                placeholder="S√©lectionner un autre type..."></app-ui-select>
                        </div>

                        <div class="form-section-header mt-6">Caract√©ristiques g√©n√©rales</div>
                        <div class="form-grid">
                            <label *ngFor="let field of buildingFields; trackBy: trackByField"
                                class="d-flex flex-col gap-2">
                                <span class="d-flex items-center justify-between gap-2">
                                  <span>{{ field.label }}</span>
                                  <app-field-tooltip *ngIf="field.tooltip" [title]="field.tooltip.title"
                                    [description]="field.tooltip.description ?? ''" [options]="field.tooltip.options ?? []" />
                                </span>
                                <ng-container *ngIf="!field.options?.length">
                                    <input [type]="field.type ?? 'text'" [formControlName]="field.control">
                                </ng-container>
                                <ng-container *ngIf="field.options?.length">
                                    <app-ui-select [options]="field.options ?? []" [formControlName]="field.control"
                                        [placeholder]="field.placeholderOption!"
                                        [multiple]="field.multiple ?? false"></app-ui-select>
                                </ng-container>
                            </label>
                        </div>
                    </div>

                    <div class="form-section" formGroupName="technical">
                        <div class="form-section-header">√âquipements & Usages</div>
                        <div class="technical-grid">
                            <label *ngFor="let field of technicalFields; trackBy: trackByField"
                                class="d-flex flex-col gap-2">
                                <span class="d-flex items-center justify-between gap-2">
                                  <span>{{ field.label }}</span>
                                  <app-field-tooltip *ngIf="field.tooltip" [title]="field.tooltip.title"
                                    [description]="field.tooltip.description ?? ''" [options]="field.tooltip.options ?? []" />
                                </span>
                                <ng-container *ngIf="!field.options?.length">
                                    <input [type]="field.type ?? 'text'" [formControlName]="field.control">
                                </ng-container>
                                <ng-container *ngIf="field.options?.length">
                                    <app-ui-select [options]="field.options ?? []" [formControlName]="field.control"
                                        [placeholder]="field.placeholderOption ?? 'S√©lectionnez...'"
                                        [multiple]="field.multiple ?? false"></app-ui-select>
                                </ng-container>
                            </label>
                        </div>
                    </div>

                    <div class="form-actions d-flex flex-column gap-3">
                        <button type="button" class="pill-button pill-button--secondary" (click)="returnToImport()">
                            <ng-icon name="lucideArrowLeft" size="16"></ng-icon>
                            Retour √† l'import
                        </button>
                        <button type="button" class="pill-button pill-button--primary"
                            (click)="continueToGeneralStep()">
                            Continuer
                            <ng-icon name="lucideArrowRight" size="16"></ng-icon>
                        </button>
                    </div>
                </ng-container>
            </form>
        </section>
    </main>
</div>