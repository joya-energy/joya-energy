<div class="google-maps-input">
  <div class="ui-input-wrapper">
    @if (label) {
      <div class="ui-input-label-row">
        <label class="ui-input-label" [class.required]="required">
          {{ label }}
        </label>
        @if (tooltipTitle) {
          <app-field-tooltip
            [title]="tooltipTitle"
            [description]="tooltipDescription">
          </app-field-tooltip>
        }
      </div>
    }

    <div class="ui-input-container has-icon icon-left" 
         [class.size-sm]="size === 'sm'" 
         [class.size-md]="size === 'md'" 
         [class.size-lg]="size === 'lg'">
      <ng-icon name="lucideMapPin" class="input-icon input-icon-left"></ng-icon>
      <input
        #addressInput
        type="text"
        class="ui-input address-input"
        [placeholder]="placeholder"
        [disabled]="isDisabled"
        (focus)="onTouched()"
        (input)="onInputChange($event)"
        autocomplete="off"
        name="address"
        id="address-input"
      />
    </div>
  </div>

  <div class="actions">
    <button type="button" class="btn-location" (click)="useCurrentLocation()" [disabled]="isDisabled || isLoading()">
      <ng-icon [name]="isLoading() ? 'lucideLoader' : 'lucideMapPin'" [class.spinning]="isLoading()"></ng-icon>
      Utiliser ma position
    </button>
    <button type="button" class="btn-toggle-map" (click)="toggleMap()" [disabled]="!selectedAddress()">
      {{ showMap() ? 'Masquer la carte' : 'Afficher la carte 3D' }}
    </button>
  </div>



  @if (showMap() && selectedAddress()) {
    <div class="map-container">
      <div #mapContainer class="map" style="width: 100%; height: 550px; border-radius: 16px;"></div>
      @if (isAnalyzingSolar()) {
        <div class="map-loading-overlay">
          <ng-icon name="lucideLoader" class="spinning"></ng-icon>
          <p>Analyse du potentiel solaire...</p>
        </div>
      }
      @if (solarInfo() && !isAnalyzingSolar()) {
        <div class="solar-info-overlay">
          <h4>Potentiel solaire détecté</h4>
          <div class="solar-stats">
            <div class="solar-stat">
              <span class="stat-label">Panneaux suggérés</span>
              <span class="stat-value">{{ solarInfo()!.maxSolarPanelCount }}</span>
            </div>
            <div class="solar-stat">
              <span class="stat-label">Surface disponible</span>
              <span class="stat-value">{{ solarInfo()!.maxArrayAreaMeters2.toFixed(1) }} m²</span>
            </div>
            <div class="solar-stat">
              <span class="stat-label">Production annuelle</span>
              <span class="stat-value">{{ solarInfo()!.maxArrayPanelsCount }} kWh</span>
            </div>
          </div>
        </div>
      }
      @if (solarAnalysisError() && !isAnalyzingSolar() && !solarInfo()) {
        <div class="solar-error-overlay">
          <p class="error-message">{{ solarAnalysisError() }}</p>
        </div>
      }
    </div>
  }
</div>

